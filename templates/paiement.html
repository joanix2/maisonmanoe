{% extends "base.html" %} {% block title %}Paiement - Maison Manoé{% endblock %} {% block description %}Finalisez votre commande en toute sécurité — paiement sécurisé par carte bancaire.{% endblock %}
{% block content %}
<section class="py-12 px-4 md:px-8 lg:px-16 bg-gray-50 min-h-screen">
  <div class="container mx-auto max-w-7xl">
    <h1 class="text-3xl md:text-4xl font-bold mb-8 lowercase">Paiement</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Formulaire de paiement -->
      <div class="lg:col-span-2">
        <form id="payment-form" class="space-y-6">
          <!-- Informations de livraison -->
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
              <span class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center mr-3 text-sm">1</span>
              Adresse de livraison
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label for="email" class="block text-sm font-medium mb-2">Email *</label>
                <input type="email" id="email" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="votre@email.com" />
              </div>

              <div>
                <label for="prenom" class="block text-sm font-medium mb-2">Prénom *</label>
                <input type="text" id="prenom" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="Jean" />
              </div>

              <div>
                <label for="nom" class="block text-sm font-medium mb-2">Nom *</label>
                <input type="text" id="nom" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="Dupont" />
              </div>

              <div class="md:col-span-2">
                <label for="adresse" class="block text-sm font-medium mb-2">Adresse *</label>
                <input type="text" id="adresse" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="12 rue de la Paix" />
              </div>

              <div class="md:col-span-2">
                <label for="complement" class="block text-sm font-medium mb-2">Complément d'adresse</label>
                <input type="text" id="complement" class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="Appartement, bâtiment, etc." />
              </div>

              <div>
                <label for="code-postal" class="block text-sm font-medium mb-2">Code postal *</label>
                <input type="text" id="code-postal" required pattern="[0-9]{5}" class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="75001" />
              </div>

              <div>
                <label for="ville" class="block text-sm font-medium mb-2">Ville *</label>
                <input type="text" id="ville" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="Paris" />
              </div>

              <div class="md:col-span-2">
                <label for="pays" class="block text-sm font-medium mb-2">Pays *</label>
                <select id="pays" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none">
                  <option value="FR" selected>France</option>
                  <option value="BE">Belgique</option>
                  <option value="CH">Suisse</option>
                  <option value="LU">Luxembourg</option>
                </select>
              </div>

              <div class="md:col-span-2">
                <label for="telephone" class="block text-sm font-medium mb-2">Téléphone *</label>
                <input type="tel" id="telephone" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="06 12 34 56 78" />
              </div>
            </div>
          </div>

          <!-- Méthode de livraison -->
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
              <span class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center mr-3 text-sm">2</span>
              Méthode de livraison
            </h2>

            <div class="space-y-3">
              <label class="flex items-center p-4 border rounded cursor-pointer hover:bg-gray-50 transition-colors">
                <input type="radio" name="livraison" value="standard" checked class="mr-3" />
                <div class="flex-grow">
                  <p class="font-medium">Livraison standard</p>
                  <p class="text-sm text-gray-600">Délai : 3-5 jours ouvrés</p>
                </div>
                <span class="font-bold">€5.90</span>
              </label>

              <label class="flex items-center p-4 border rounded cursor-pointer hover:bg-gray-50 transition-colors">
                <input type="radio" name="livraison" value="express" class="mr-3" />
                <div class="flex-grow">
                  <p class="font-medium">Livraison express</p>
                  <p class="text-sm text-gray-600">Délai : 24-48h</p>
                </div>
                <span class="font-bold">€12.90</span>
              </label>

              <label class="flex items-center p-4 border rounded cursor-pointer hover:bg-gray-50 transition-colors">
                <input type="radio" name="livraison" value="gratuite" class="mr-3" />
                <div class="flex-grow">
                  <p class="font-medium">Livraison gratuite</p>
                  <p class="text-sm text-gray-600">Délai : 7-10 jours ouvrés</p>
                </div>
                <span class="font-bold text-green-600">Gratuit</span>
              </label>
            </div>
          </div>

          <!-- Informations de paiement -->
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
              <span class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center mr-3 text-sm">3</span>
              Paiement
            </h2>

            <div class="mb-4">
              <div class="flex gap-2 mb-4">
                <img src="https://img.icons8.com/color/48/visa.png" alt="Visa" class="h-8" />
                <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard" class="h-8" />
                <img src="https://img.icons8.com/color/48/amex.png" alt="American Express" class="h-8" />
              </div>
            </div>

            <div class="space-y-4">
              <div>
                <label for="card-number" class="block text-sm font-medium mb-2">Numéro de carte *</label>
                <input
                  type="text"
                  id="card-number"
                  required
                  pattern="[0-9]{16}"
                  maxlength="19"
                  class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none"
                  placeholder="1234 5678 9012 3456"
                />
              </div>

              <div>
                <label for="card-name" class="block text-sm font-medium mb-2">Nom sur la carte *</label>
                <input type="text" id="card-name" required class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="JEAN DUPONT" />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="card-expiry" class="block text-sm font-medium mb-2">Date d'expiration *</label>
                  <input
                    type="text"
                    id="card-expiry"
                    required
                    pattern="[0-9]{2}/[0-9]{2}"
                    maxlength="5"
                    class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none"
                    placeholder="MM/AA"
                  />
                </div>

                <div>
                  <label for="card-cvv" class="block text-sm font-medium mb-2">CVV *</label>
                  <input type="text" id="card-cvv" required pattern="[0-9]{3,4}" maxlength="4" class="w-full px-4 py-2 border rounded focus:border-maison-beige focus:outline-none" placeholder="123" />
                </div>
              </div>
            </div>

            <div class="mt-6 p-4 bg-blue-50 rounded border border-blue-200">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="text-sm text-blue-800">
                  <p class="font-medium mb-1">Paiement 100% sécurisé</p>
                  <p>Vos informations de paiement sont cryptées et sécurisées. Nous ne conservons pas vos données bancaires.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Conditions -->
          <div class="bg-white rounded-lg shadow p-6">
            <label class="flex items-start cursor-pointer">
              <input type="checkbox" id="accept-cgv" required class="mt-1 mr-3" />
              <span class="text-sm">
                J'accepte les <a href="/confidentialite" class="text-maison-beige hover:underline">conditions générales de vente</a> et la
                <a href="/confidentialite" class="text-maison-beige hover:underline">politique de confidentialité</a> *
              </span>
            </label>
          </div>
        </form>
      </div>

      <!-- Résumé de commande -->
      <aside class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6 sticky top-24">
          <h2 class="text-xl font-bold mb-4">Résumé</h2>

          <!-- Produits -->
          <div class="space-y-3 mb-4 pb-4 border-b">
            <div class="flex gap-3">
              <img src="https://picsum.photos/60/60?random=1" alt="Produit" class="w-12 h-12 object-cover rounded" />
              <div class="flex-grow">
                <p class="text-sm font-medium">Vase en céramique</p>
                <p class="text-xs text-gray-600">Qté : 1</p>
              </div>
              <span class="text-sm font-medium">€45.99</span>
            </div>

            <div class="flex gap-3">
              <img src="https://picsum.photos/60/60?random=2" alt="Produit" class="w-12 h-12 object-cover rounded" />
              <div class="flex-grow">
                <p class="text-sm font-medium">Bougeoir en laiton</p>
                <p class="text-xs text-gray-600">Qté : 2</p>
              </div>
              <span class="text-sm font-medium">€65.00</span>
            </div>

            <div class="flex gap-3">
              <img src="https://picsum.photos/60/60?random=3" alt="Produit" class="w-12 h-12 object-cover rounded" />
              <div class="flex-grow">
                <p class="text-sm font-medium">Coussin brodé</p>
                <p class="text-xs text-gray-600">Qté : 1</p>
              </div>
              <span class="text-sm font-medium">€28.50</span>
            </div>
          </div>

          <!-- Totaux -->
          <div class="space-y-2 mb-4 pb-4 border-b">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Sous-total</span>
              <span id="subtotal">€139.49</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Livraison</span>
              <span id="shipping-cost">€5.90</span>
            </div>
          </div>

          <div class="flex justify-between text-lg font-bold mb-6">
            <span>Total</span>
            <span id="total-amount">€145.39</span>
          </div>

          <button type="submit" form="payment-form" id="pay-button" class="w-full bg-black text-white py-3 rounded hover:bg-gray-800 transition-colors font-medium mb-3">Payer €145.39</button>

          <a href="/panier" class="block text-center text-sm text-maison-beige hover:underline"> ← Retour au panier </a>
        </div>
      </aside>
    </div>
  </div>
</section>

<script>
  // State Machine pour le paiement
  class PaymentStateMachine {
    constructor() {
      this.state = "idle"; // idle, validating, processing, success, error
      this.shippingCost = 5.9;
      this.subtotal = 139.49;
      this.init();
    }

    init() {
      // Formatage automatique des champs
      this.setupCardFormatting();

      // Gestion du changement de méthode de livraison
      document.querySelectorAll('input[name="livraison"]').forEach((radio) => {
        radio.addEventListener("change", (e) => {
          this.updateShippingCost(e.target.value);
        });
      });

      // Gestion de la soumission du formulaire
      document.getElementById("payment-form").addEventListener("submit", (e) => {
        e.preventDefault();
        this.processPayment();
      });
    }

    setupCardFormatting() {
      // Formatage du numéro de carte
      const cardNumber = document.getElementById("card-number");
      cardNumber.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\s/g, "");
        let formattedValue = value.match(/.{1,4}/g)?.join(" ") || value;
        e.target.value = formattedValue;
      });

      // Formatage de la date d'expiration
      const cardExpiry = document.getElementById("card-expiry");
      cardExpiry.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length >= 2) {
          value = value.slice(0, 2) + "/" + value.slice(2, 4);
        }
        e.target.value = value;
      });

      // Limitation CVV à chiffres uniquement
      const cardCvv = document.getElementById("card-cvv");
      cardCvv.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/\D/g, "");
      });
    }

    updateShippingCost(method) {
      const costs = {
        standard: 5.9,
        express: 12.9,
        gratuite: 0,
      };

      this.shippingCost = costs[method];
      const total = this.subtotal + this.shippingCost;

      // Mettre à jour l'affichage
      document.getElementById("shipping-cost").textContent = this.shippingCost === 0 ? "Gratuit" : `€${this.shippingCost.toFixed(2)}`;
      document.getElementById("total-amount").textContent = `€${total.toFixed(2)}`;
      document.getElementById("pay-button").textContent = `Payer €${total.toFixed(2)}`;
    }

    async processPayment() {
      if (this.state === "processing") return;

      this.transition("validating");

      // Validation des champs
      const form = document.getElementById("payment-form");
      if (!form.checkValidity()) {
        this.transition("idle");
        form.reportValidity();
        return;
      }

      this.transition("processing");

      const payButton = document.getElementById("pay-button");
      const originalText = payButton.textContent;
      payButton.disabled = true;
      payButton.innerHTML = `
      <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    `;

      // Simulation du traitement du paiement
      // En production, ici vous feriez un appel à Stripe ou Lemon Squeezy
      try {
        await this.simulatePaymentProcessing();

        this.transition("success");

        // Sauvegarder les informations de commande
        this.saveOrderInfo();

        // Redirection vers la page de confirmation
        window.location.href = "/validation-paiement";
      } catch (error) {
        this.transition("error");
        payButton.disabled = false;
        payButton.textContent = originalText;

        alert("Une erreur est survenue lors du paiement. Veuillez réessayer.");
      }
    }

    async simulatePaymentProcessing() {
      // Simulation d'un délai de traitement
      return new Promise((resolve) => {
        setTimeout(resolve, 2000);
      });
    }

    saveOrderInfo() {
      const orderData = {
        orderId: "CMD-" + Date.now(),
        date: new Date().toISOString(),
        email: document.getElementById("email").value,
        shipping: {
          prenom: document.getElementById("prenom").value,
          nom: document.getElementById("nom").value,
          adresse: document.getElementById("adresse").value,
          complement: document.getElementById("complement").value,
          codePostal: document.getElementById("code-postal").value,
          ville: document.getElementById("ville").value,
          pays: document.getElementById("pays").value,
          telephone: document.getElementById("telephone").value,
        },
        shippingMethod: document.querySelector('input[name="livraison"]:checked').value,
        subtotal: this.subtotal,
        shippingCost: this.shippingCost,
        total: this.subtotal + this.shippingCost,
      };

      localStorage.setItem("maison_manoe_last_order", JSON.stringify(orderData));
    }

    transition(newState) {
      console.log(`Payment state: ${this.state} → ${newState}`);
      this.state = newState;
    }
  }

  // Initialiser au chargement de la page
  document.addEventListener("DOMContentLoaded", () => {
    new PaymentStateMachine();
  });
</script>
{% endblock %}
