{% extends "client/base.html" %} {% block title %}Mon profil - Maison Mano√©{% endblock %} {% block description %}Espace profil utilisateur ‚Äî informations personnelles, adresses et commandes.{%
endblock %} {% block extra_head %}
<style>
  .profile-section {
    display: none;
  }
  .profile-section.active {
    display: block;
  }
  .nav-item.active {
    background-color: #d3c2a1;
    font-weight: 600;
  }
</style>
{% endblock %} {% block content %}
<section class="py-12 px-4 md:px-8 lg:px-16 bg-gray-50 min-h-screen">
  <div class="container mx-auto max-w-5xl">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Sidebar profil -->
        <aside class="w-full md:w-1/3 flex flex-col items-center text-center md:text-left">
          <div class="w-32 h-32 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center">
            <!-- avatar placeholder avec initiales -->
            <span id="user-avatar" class="text-4xl font-semibold text-maison-beige">--</span>
          </div>
          <h2 id="user-full-name" class="mt-4 text-xl font-semibold">Chargement...</h2>
          <p id="user-email" class="text-sm text-gray-500">--</p>

          <nav class="mt-6 w-full" id="profile-nav">
            <ul class="space-y-2 text-left">
              <li><button data-section="informations" class="nav-item active w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">Informations</button></li>
              <li><button data-section="adresses" class="nav-item w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">Adresses</button></li>
              <li><button data-section="commandes" class="nav-item w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">Commandes</button></li>
              <li><button data-section="favoris" class="nav-item w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">Favoris</button></li>
              <li><button data-section="securite" class="nav-item w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">S√©curit√©</button></li>
              <li><button id="logout-btn" class="w-full text-left px-3 py-2 rounded text-red-600 hover:bg-red-50 transition-colors">Se d√©connecter</button></li>
            </ul>
          </nav>
        </aside>

        <!-- Contenu principal -->
        <main class="w-full md:w-2/3" id="profile-content">
          <!-- Informations -->
          <section id="informations" class="profile-section active mb-6">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Informations personnelles</h3>
              <a href="#" class="text-sm text-maison-beige hover:underline">Modifier</a>
            </div>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-600">Pr√©nom</label>
                <p id="info-first-name" class="mt-1 font-medium">--</p>
              </div>
              <div>
                <label class="text-sm text-gray-600">Nom</label>
                <p id="info-last-name" class="mt-1 font-medium">--</p>
              </div>
              <div>
                <label class="text-sm text-gray-600">Email</label>
                <p id="info-email" class="mt-1 font-medium">--</p>
              </div>
              <div>
                <label class="text-sm text-gray-600">T√©l√©phone</label>
                <p id="info-phone" class="mt-1 font-medium">--</p>
              </div>
              <div class="sm:col-span-2">
                <label class="text-sm text-gray-600">Compte cr√©√© le</label>
                <p id="info-created" class="mt-1 font-medium">--</p>
              </div>
              <div class="sm:col-span-2" id="admin-badge-container" style="display: none">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800"> üëë Compte Administrateur </span>
              </div>
            </div>
          </section>

          <!-- Adresses -->
          <section id="adresses" class="profile-section mb-6">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Adresses</h3>
              <a href="#" class="text-sm text-maison-beige hover:underline">Ajouter une adresse</a>
            </div>
            <div class="mt-4 grid grid-cols-1 gap-4">
              <div class="border rounded p-4">
                <p class="font-medium">Maison ‚Äî 12 rue des Fleurs</p>
                <p class="text-sm text-gray-600">75001 Paris, France</p>
                <p class="text-sm text-gray-600">+33 6 12 34 56 78</p>
              </div>
            </div>
          </section>

          <!-- Commandes -->
          <section id="commandes" class="profile-section mb-6">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Commandes r√©centes</h3>
              <a href="#" class="text-sm text-maison-beige hover:underline">Voir l'historique</a>
            </div>
            <div class="mt-4 space-y-4">
              <div class="border rounded p-4 flex items-center justify-between">
                <div>
                  <p class="font-medium">Commande #2025-001</p>
                  <p class="text-sm text-gray-600">Exp√©di√©e le 12/11/2025 ‚Äî ‚Ç¨89.99</p>
                </div>
                <a href="#" class="text-sm text-maison-beige hover:underline">D√©tails</a>
              </div>
            </div>
          </section>

          <!-- Favoris -->
          <section id="favoris" class="profile-section mb-6">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Mes favoris</h3>
              <a href="/favoris" class="text-sm text-maison-beige hover:underline">Voir tous</a>
            </div>
            <div class="mt-4 text-gray-600">
              <p>8 produits dans votre liste de favoris</p>
            </div>
          </section>

          <!-- S√©curit√© -->
          <section id="securite" class="profile-section mb-6">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">S√©curit√©</h3>
              <a href="#" class="text-sm text-maison-beige hover:underline">Changer le mot de passe</a>
            </div>
            <div class="mt-4 space-y-3">
              <div>
                <label class="text-sm text-gray-600">Statut du compte</label>
                <p id="account-status" class="mt-1 font-medium text-green-600">Actif</p>
              </div>
              <div>
                <label class="text-sm text-gray-600">Derni√®re modification</label>
                <p id="last-updated" class="mt-1 font-medium">--</p>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>
</section>

<script>
  // State Machine pour la navigation du profil
  class ProfileStateMachine {
    constructor() {
      this.currentState = "informations";
      this.states = ["informations", "adresses", "commandes", "favoris", "securite"];
      this.init();
    }

    init() {
      // R√©cup√©rer tous les boutons de navigation
      const navButtons = document.querySelectorAll(".nav-item");

      navButtons.forEach((button) => {
        button.addEventListener("click", (e) => {
          const targetSection = e.target.dataset.section;
          this.transition(targetSection);
        });
      });
    }

    transition(newState) {
      // V√©rifier que le nouvel √©tat est valide
      if (!this.states.includes(newState)) {
        console.error(`√âtat invalide: ${newState}`);
        return;
      }

      // Si on est d√©j√† dans cet √©tat, ne rien faire
      if (this.currentState === newState) {
        return;
      }

      // Transition: sortir de l'ancien √©tat
      this.exitState(this.currentState);

      // Mettre √† jour l'√©tat actuel
      this.currentState = newState;

      // Transition: entrer dans le nouvel √©tat
      this.enterState(newState);
    }

    exitState(state) {
      // Retirer la classe active de la section
      const section = document.getElementById(state);
      if (section) {
        section.classList.remove("active");
      }

      // Retirer la classe active du bouton de navigation
      const navButton = document.querySelector(`[data-section="${state}"]`);
      if (navButton) {
        navButton.classList.remove("active");
      }
    }

    enterState(state) {
      // Ajouter la classe active √† la section
      const section = document.getElementById(state);
      if (section) {
        section.classList.add("active");
      }

      // Ajouter la classe active au bouton de navigation
      const navButton = document.querySelector(`[data-section="${state}"]`);
      if (navButton) {
        navButton.classList.add("active");
      }

      // Optionnel: sauvegarder l'√©tat dans l'URL sans scroll
      history.replaceState(null, "", `#${state}`);
    }

    // M√©thode pour obtenir l'√©tat actuel
    getState() {
      return this.currentState;
    }
  }

  // Initialiser la state machine au chargement de la page
  document.addEventListener("DOMContentLoaded", async () => {
    // Prot√©ger la page (rediriger si non connect√©)
    MaisonManoeAuth.requireAuth("/connexion?return=/profile");

    const profileSM = new ProfileStateMachine();

    // Si un hash est pr√©sent dans l'URL, naviguer vers cette section
    const hash = window.location.hash.slice(1);
    if (hash && profileSM.states.includes(hash)) {
      profileSM.transition(hash);
    }

    // Charger les donn√©es utilisateur
    await loadUserData();

    // G√©rer la d√©connexion
    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("√ätes-vous s√ªr de vouloir vous d√©connecter ?")) {
          MaisonManoeAuth.logout("/");
        }
      });
    }
  });

  /**
   * Charge et affiche les donn√©es de l'utilisateur connect√©
   */
  async function loadUserData() {
    try {
      // R√©cup√©rer l'utilisateur depuis le localStorage/sessionStorage
      const user = MaisonManoeAuth.getCurrentUser();

      if (!user) {
        console.error("Aucun utilisateur trouv√©");
        window.location.href = "/connexion";
        return;
      }

      // Sidebar
      document.getElementById("user-full-name").textContent = `${user.first_name} ${user.last_name}`;
      document.getElementById("user-email").textContent = user.email;

      // Avatar avec initiales
      const initials = `${user.first_name.charAt(0)}${user.last_name.charAt(0)}`.toUpperCase();
      document.getElementById("user-avatar").textContent = initials;

      // Section Informations
      document.getElementById("info-first-name").textContent = user.first_name;
      document.getElementById("info-last-name").textContent = user.last_name;
      document.getElementById("info-email").textContent = user.email;
      document.getElementById("info-phone").textContent = user.phone || "Non renseign√©";

      // Formater la date de cr√©ation
      if (user.created_at) {
        const createdDate = new Date(user.created_at);
        document.getElementById("info-created").textContent = createdDate.toLocaleDateString("fr-FR", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });
      }

      // Badge admin si applicable
      if (user.is_admin) {
        document.getElementById("admin-badge-container").style.display = "block";
      }

      // Section S√©curit√©
      document.getElementById("account-status").textContent = user.is_active ? "Actif" : "Inactif";
      document.getElementById("account-status").className = user.is_active ? "mt-1 font-medium text-green-600" : "mt-1 font-medium text-red-600";

      if (user.updated_at) {
        const updatedDate = new Date(user.updated_at);
        document.getElementById("last-updated").textContent = updatedDate.toLocaleDateString("fr-FR", {
          day: "numeric",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    } catch (error) {
      console.error("Erreur lors du chargement des donn√©es utilisateur:", error);
      alert("Impossible de charger vos informations. Veuillez vous reconnecter.");
      MaisonManoeAuth.logout("/connexion");
    }
  }
</script>
{% endblock %}
