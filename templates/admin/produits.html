{% extends "admin/base.html" %} {% block title %}Produits{% endblock %} {% block page_title %}Gestion des produits{% endblock %} {% block content %}
<!-- Header avec recherche et bouton -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 md:mb-6 gap-3 md:gap-4">
  <div class="flex-1 sm:max-w-md">
    <div class="relative">
      <input
        type="text"
        id="search-products"
        placeholder="Rechercher un produit..."
        class="w-full px-3 md:px-4 py-2 pl-9 md:pl-10 text-sm md:text-base border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
      />
      <svg class="w-4 h-4 md:w-5 md:h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
  </div>
  <button
    id="create-product-btn"
    class="px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-2 whitespace-nowrap text-sm md:text-base"
  >
    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
    </svg>
    Nouveau produit
  </button>
</div>

<!-- Filtres -->
<div class="mb-4 md:mb-6 flex flex-col sm:flex-row gap-2 md:gap-3">
  <select class="flex-1 sm:flex-none px-3 md:px-4 py-2 text-sm md:text-base border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
    <option>Toutes les catégories</option>
    <option>Décoration</option>
    <option>Mobilier</option>
    <option>Luminaires</option>
    <option>Textile</option>
  </select>
  <select class="flex-1 sm:flex-none px-3 md:px-4 py-2 text-sm md:text-base border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
    <option>Tous les statuts</option>
    <option>En ligne</option>
    <option>Brouillon</option>
    <option>Rupture de stock</option>
  </select>
</div>

<!-- Liste des produits en grille -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6" id="products-grid">
  <!-- Les produits seront chargés dynamiquement depuis l'API -->
  <div class="col-span-full text-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
    <p class="text-gray-600">Chargement des produits...</p>
  </div>
</div>

<!-- Modal édition produit -->
<div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white">
      <h3 class="text-xl font-semibold text-gray-900" id="modal-title">Modifier le produit</h3>
      <button id="close-modal" class="text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <form id="product-form" class="p-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Colonne gauche : Images -->
        <div class="space-y-4">
          <h4 class="font-semibold text-gray-900 mb-4">Photos du produit</h4>

          <!-- Image principale -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Image principale *</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer" id="main-image-upload">
              <div id="main-image-preview" class="hidden">
                <img src="" alt="Preview" class="w-full h-48 object-cover rounded mb-2" />
                <button type="button" class="text-sm text-red-600 hover:text-red-800">Supprimer</button>
              </div>
              <div id="main-image-placeholder">
                <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                <p class="text-sm text-gray-600">Cliquez ou glissez une image</p>
                <p class="text-xs text-gray-500 mt-1">JPG, PNG jusqu'à 5MB</p>
              </div>
              <input type="file" id="main-image-input" accept="image/*" class="hidden" />
            </div>
          </div>

          <!-- Images secondaires -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Images supplémentaires</label>
            <div class="grid grid-cols-3 gap-2" id="additional-images">
              <div class="border-2 border-dashed border-gray-300 rounded aspect-square flex items-center justify-center cursor-pointer hover:border-blue-500 transition-colors" id="add-image-btn">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
              </div>
            </div>
            <input type="file" id="additional-images-input" accept="image/*" multiple class="hidden" />
          </div>
        </div>

        <!-- Colonne droite : Informations -->
        <div class="space-y-4">
          <h4 class="font-semibold text-gray-900 mb-4">Informations du produit</h4>

          <!-- Nom -->
          <div>
            <label for="product-name" class="block text-sm font-medium text-gray-700 mb-2">Nom du produit *</label>
            <input
              type="text"
              id="product-name"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              placeholder="Vase céramique artisanal"
            />
          </div>

          <!-- Catégorie -->
          <div>
            <label for="product-category" class="block text-sm font-medium text-gray-700 mb-2">Catégorie *</label>
            <select id="product-category" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
              <option value="">Sélectionner une catégorie</option>
              <option value="decoration">Décoration</option>
              <option value="mobilier">Mobilier</option>
              <option value="luminaires">Luminaires</option>
              <option value="textile">Textile</option>
              <option value="accessoires">Accessoires</option>
            </select>
          </div>

          <!-- Prix et Stock -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="product-price" class="block text-sm font-medium text-gray-700 mb-2">Prix (€) *</label>
              <input
                type="number"
                id="product-price"
                required
                min="0"
                step="0.01"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                placeholder="45.00"
              />
            </div>
            <div>
              <label for="product-stock" class="block text-sm font-medium text-gray-700 mb-2">Stock *</label>
              <input
                type="number"
                id="product-stock"
                required
                min="0"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                placeholder="12"
              />
            </div>
          </div>

          <!-- Description courte -->
          <div>
            <label for="product-short-desc" class="block text-sm font-medium text-gray-700 mb-2">Description courte</label>
            <textarea
              id="product-short-desc"
              rows="2"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 resize-none"
              placeholder="Une ligne d'accroche pour le produit..."
            ></textarea>
          </div>

          <!-- Description complète -->
          <div>
            <label for="product-description" class="block text-sm font-medium text-gray-700 mb-2">Description complète *</label>
            <textarea
              id="product-description"
              required
              rows="6"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 resize-none"
              placeholder="Décrivez votre produit en détail..."
            ></textarea>
          </div>

          <!-- Dimensions -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Dimensions</label>
            <div class="grid grid-cols-3 gap-2">
              <input type="text" id="product-width" class="px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm" placeholder="L (cm)" />
              <input type="text" id="product-height" class="px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm" placeholder="H (cm)" />
              <input type="text" id="product-depth" class="px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm" placeholder="P (cm)" />
            </div>
          </div>

          <!-- Statut -->
          <div>
            <label for="product-status" class="block text-sm font-medium text-gray-700 mb-2">Statut *</label>
            <select id="product-status" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
              <option value="online">En ligne</option>
              <option value="draft">Brouillon</option>
              <option value="out-of-stock">Rupture de stock</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Boutons -->
      <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
        <button type="button" id="delete-product-btn" class="px-6 py-3 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors font-medium">Supprimer</button>
        <div class="flex-1"></div>
        <button type="button" id="cancel-btn" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">Annuler</button>
        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  // État global
  let currentProductId = null;
  let allProducts = [];

  // Modal management
  const modal = document.getElementById("product-modal");
  const modalTitle = document.getElementById("modal-title");
  const createBtn = document.getElementById("create-product-btn");
  const closeModalBtn = document.getElementById("close-modal");
  const cancelBtn = document.getElementById("cancel-btn");

  // Charger les produits au démarrage
  document.addEventListener("DOMContentLoaded", () => {
    loadProducts();
  });

  // Charger tous les produits depuis l'API
  async function loadProducts() {
    try {
      const response = await fetch("/api/products?limit=100");
      if (!response.ok) throw new Error("Erreur lors du chargement des produits");

      allProducts = await response.json();
      displayProducts(allProducts);
    } catch (error) {
      console.error("Erreur:", error);
      alert("Impossible de charger les produits. Vérifiez que le serveur est démarré.");
    }
  }

  // Afficher les produits dans la grille
  function displayProducts(products) {
    const grid = document.getElementById("products-grid");

    if (products.length === 0) {
      grid.innerHTML = `
        <div class="col-span-full text-center py-12">
          <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
          </svg>
          <p class="text-gray-600 text-lg mb-4">Aucun produit pour le moment</p>
          <button onclick="document.getElementById('create-product-btn').click()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
            Créer votre premier produit
          </button>
        </div>
      `;
      return;
    }

    grid.innerHTML = products.map((product) => createProductCard(product)).join("");

    // Ajouter les événements de clic
    document.querySelectorAll(".product-card").forEach((card) => {
      card.addEventListener("click", () => {
        const productId = card.dataset.productId;
        openEditModal(productId);
      });
    });
  }

  // Créer une carte produit
  function createProductCard(product) {
    const statusColors = {
      online: "bg-green-100 text-green-800",
      draft: "bg-gray-100 text-gray-800",
      "out-of-stock": "bg-red-100 text-red-800",
    };

    const statusLabels = {
      online: "En ligne",
      draft: "Brouillon",
      "out-of-stock": "Rupture de stock",
    };

    const stockColor = product.stock < 5 ? "text-red-600" : "text-gray-600";
    const imageUrl = product.main_image || "https://images.unsplash.com/photo-1578500494198-246f612d3b3d?w=400";

    return `
      <div class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer product-card" data-product-id="${product.id}">
        <div class="aspect-square bg-gray-100 rounded-t-lg overflow-hidden">
          <img src="${imageUrl}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1578500494198-246f612d3b3d?w=400'" />
        </div>
        <div class="p-3 md:p-4">
          <div class="flex items-start justify-between mb-2 gap-2">
            <h3 class="text-sm md:text-base font-semibold text-gray-900 line-clamp-2">${product.name}</h3>
            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[product.status]} flex-shrink-0">
              ${statusLabels[product.status]}
            </span>
          </div>
          <p class="text-xs md:text-sm text-gray-500 mb-2 md:mb-3">${product.category}</p>
          <div class="flex items-center justify-between">
            <span class="text-base md:text-lg font-bold text-gray-900">${parseFloat(product.price).toFixed(2)} €</span>
            <span class="text-xs md:text-sm ${stockColor}">Stock: ${product.stock}</span>
          </div>
        </div>
      </div>
    `;
  }

  // Open modal for new product
  createBtn.addEventListener("click", () => {
    currentProductId = null;
    modalTitle.textContent = "Nouveau produit";
    document.getElementById("product-form").reset();
    document.getElementById("delete-product-btn").classList.add("hidden");
    clearImagePreviews();
    modal.classList.remove("hidden");
  });

  // Ouvrir le modal pour éditer un produit
  async function openEditModal(productId) {
    currentProductId = productId;
    modalTitle.textContent = "Modifier le produit";
    document.getElementById("delete-product-btn").classList.remove("hidden");

    try {
      const response = await fetch(`/api/products/${productId}`);
      if (!response.ok) throw new Error("Produit non trouvé");

      const product = await response.json();
      fillFormWithProduct(product);
      modal.classList.remove("hidden");
    } catch (error) {
      console.error("Erreur:", error);
      alert("Impossible de charger le produit");
    }
  }

  // Remplir le formulaire avec les données d'un produit
  function fillFormWithProduct(product) {
    document.getElementById("product-name").value = product.name || "";
    document.getElementById("product-category").value = product.category || "";
    document.getElementById("product-price").value = product.price || "";
    document.getElementById("product-stock").value = product.stock || "";
    document.getElementById("product-short-desc").value = product.short_description || "";
    document.getElementById("product-description").value = product.description || "";
    document.getElementById("product-width").value = product.width || "";
    document.getElementById("product-height").value = product.height || "";
    document.getElementById("product-depth").value = product.depth || "";
    document.getElementById("product-status").value = product.status || "draft";

    // Afficher l'image principale si elle existe
    if (product.main_image) {
      const mainImagePreview = document.getElementById("main-image-preview");
      const mainImagePlaceholder = document.getElementById("main-image-placeholder");
      mainImagePreview.querySelector("img").src = product.main_image;
      mainImagePreview.classList.remove("hidden");
      mainImagePlaceholder.classList.add("hidden");
    }

    // TODO: Afficher les images additionnelles
  }

  function closeModal() {
    modal.classList.add("hidden");
    document.getElementById("product-form").reset();
    clearImagePreviews();
    currentProductId = null;
  }

  function clearImagePreviews() {
    const mainImagePreview = document.getElementById("main-image-preview");
    const mainImagePlaceholder = document.getElementById("main-image-placeholder");
    mainImagePreview.classList.add("hidden");
    mainImagePlaceholder.classList.remove("hidden");

    // Supprimer les images additionnelles sauf le bouton d'ajout
    const container = document.getElementById("additional-images");
    const addBtn = document.getElementById("add-image-btn");
    container.innerHTML = "";
    container.appendChild(addBtn);
  }

  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);

  // Close modal on outside click
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });

  // Image uploads
  const mainImageUpload = document.getElementById("main-image-upload");
  const mainImageInput = document.getElementById("main-image-input");
  const mainImagePreview = document.getElementById("main-image-preview");
  const mainImagePlaceholder = document.getElementById("main-image-placeholder");

  mainImageUpload.addEventListener("click", () => {
    mainImageInput.click();
  });

  mainImageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        mainImagePreview.querySelector("img").src = e.target.result;
        mainImagePreview.classList.remove("hidden");
        mainImagePlaceholder.classList.add("hidden");
      };
      reader.readAsDataURL(file);
    }
  });

  // Additional images
  const addImageBtn = document.getElementById("add-image-btn");
  const additionalImagesInput = document.getElementById("additional-images-input");
  const additionalImagesContainer = document.getElementById("additional-images");

  addImageBtn.addEventListener("click", () => {
    additionalImagesInput.click();
  });

  additionalImagesInput.addEventListener("change", (e) => {
    Array.from(e.target.files).forEach((file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement("div");
        div.className = "border rounded aspect-square overflow-hidden relative group";
        div.innerHTML = `
        <img src="${e.target.result}" class="w-full h-full object-cover" />
        <button type="button" class="absolute top-1 right-1 bg-red-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity remove-image">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `;

        // Insert before add button
        additionalImagesContainer.insertBefore(div, addImageBtn);

        // Remove image
        div.querySelector(".remove-image").addEventListener("click", (e) => {
          e.stopPropagation();
          div.remove();
        });
      };
      reader.readAsDataURL(file);
    });
  });

  // Form submission
  document.getElementById("product-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "Enregistrement...";

    try {
      const productData = {
        name: document.getElementById("product-name").value,
        category: document.getElementById("product-category").value,
        price: parseFloat(document.getElementById("product-price").value),
        stock: parseInt(document.getElementById("product-stock").value),
        short_description: document.getElementById("product-short-desc").value || null,
        description: document.getElementById("product-description").value,
        width: parseFloat(document.getElementById("product-width").value) || null,
        height: parseFloat(document.getElementById("product-height").value) || null,
        depth: parseFloat(document.getElementById("product-depth").value) || null,
        status: document.getElementById("product-status").value,
        // TODO: Gérer l'upload d'images
        main_image: null,
        additional_images: [],
      };

      let response;
      if (currentProductId) {
        // Mise à jour
        response = await fetch(`/api/products/${currentProductId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(productData),
        });
      } else {
        // Création
        response = await fetch("/api/products", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(productData),
        });
      }

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "Erreur lors de l'enregistrement");
      }

      const savedProduct = await response.json();
      console.log("Produit enregistré:", savedProduct);

      // Afficher un message de succès
      showNotification("Produit enregistré avec succès !", "success");

      // Recharger la liste des produits
      await loadProducts();

      closeModal();
    } catch (error) {
      console.error("Erreur:", error);
      showNotification(error.message || "Erreur lors de l'enregistrement", "error");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  // Delete product
  document.getElementById("delete-product-btn").addEventListener("click", async function () {
    if (!currentProductId) return;

    if (!confirm("Êtes-vous sûr de vouloir supprimer ce produit ? Cette action est irréversible.")) {
      return;
    }

    const deleteBtn = this;
    const originalText = deleteBtn.textContent;
    deleteBtn.disabled = true;
    deleteBtn.textContent = "Suppression...";

    try {
      const response = await fetch(`/api/products/${currentProductId}`, {
        method: "DELETE",
      });

      if (!response.ok) {
        throw new Error("Erreur lors de la suppression");
      }

      showNotification("Produit supprimé avec succès !", "success");
      await loadProducts();
      closeModal();
    } catch (error) {
      console.error("Erreur:", error);
      showNotification("Erreur lors de la suppression", "error");
      deleteBtn.disabled = false;
      deleteBtn.textContent = originalText;
    }
  });

  // Search
  document.getElementById("search-products").addEventListener("input", function (e) {
    const search = e.target.value.toLowerCase();
    const filteredProducts = allProducts.filter(
      (product) => product.name.toLowerCase().includes(search) || product.category.toLowerCase().includes(search) || product.description.toLowerCase().includes(search)
    );
    displayProducts(filteredProducts);
  });

  // Fonction pour afficher des notifications
  function showNotification(message, type = "info") {
    // Créer une notification toast
    const notification = document.createElement("div");
    notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white transform transition-all duration-300 ${
      type === "success" ? "bg-green-600" : type === "error" ? "bg-red-600" : "bg-blue-600"
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Animer l'entrée
    setTimeout(() => {
      notification.style.transform = "translateX(0)";
    }, 10);

    // Retirer après 3 secondes
    setTimeout(() => {
      notification.style.transform = "translateX(400px)";
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
</script>
{% endblock %}
